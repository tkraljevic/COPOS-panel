<!DOCTYPE html>
<html lang="hr">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="refresh" content="3600" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>COPOS – Status Dionica</title>
    <link rel="stylesheet" href="style.css" />
    <meta name="theme-color" content="#0b1118">
</head>

<body>
    <div class="app">

        <!-- HEADER -->
        <header class="header">
            <div>
                <div class="header__title">STATUS DIONICA</div>
                <div class="header__subtitle">Pregled branjenih dionica i odgovornih osoba</div>
            </div>
        </header>

        <!-- CONTENT -->
        <main class="content">
            <!-- Loading State -->
            <div id="loadingState" class="state-container">
                <div class="spinner"></div>
                <div class="state-title">Učitavanje podataka...</div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="state-container" style="display: none;">
                <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <div class="state-title">Greška</div>
                <div class="state-desc" id="errorMsg">Nije moguće dohvatiti podatke.</div>
                <button class="btn-retry" onclick="loadData()">Pokušaj ponovno</button>
            </div>

            <div class="table-responsive">
                <table class="table table--compact" id="dataTable" style="display: none;">
                    <thead>
                        <tr>
                            <th class="th--w-25">Dionica / Vodotok</th>
                            <th class="th--w-15">Status</th>
                            <th class="th--w-15">Mjerodavna Postaja</th>
                            <th class="th--w-15">Kriterij</th>
                            <th class="th--w-20">Rukovoditelj / Zamjenik</th>
                            <th class="th--w-10 text-left">Vodočuvari</th>
                        </tr>
                    </thead>

                    <tbody id="tableBody">
                        <!-- Rows will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </main>



    </div>

    <!-- Uključujemo naš parser za CSV -->
    <script src="js/csv-parser.js"></script>
    <script>
        /**
         * Pomoćna funkcija: Određuje boju statusa
         * @param {string} statusText
         * @returns {string} ime CSS klase
         */
        function getStatusClass(statusText) {
            if (!statusText) return "";
            const lower = statusText.toLowerCase();

            // Redoslijed je važan zbog preklapanja riječi (npr. izvanredno sadrži izvanredn)

            // 1. IZVANREDNO STANJE (Najjače - Ljubičasta)
            if (lower.includes("izvanredno")) return "status--izvanredno";

            // 2. IZVANREDNE MJERE / IZVANREDNA OBRANA (Crvena)
            // Matchevi: "izvanredne", "izvanredna"
            if (lower.includes("izvanredn")) return "status--izvanredna";

            // 3. REDOVNE MJERE / REDOVNA OBRANA (Narančasta)
            // Matchevi: "redovne", "redovna"
            if (lower.includes("redovn")) return "status--redovna";

            // 4. PRIPREMNO STANJE (Žuta)
            // Matchevi: "pripremno", "priprema"
            if (lower.includes("pripremno") || lower.includes("pripremn")) return "status--pripremno";

            // 5. NORMALNO STANJE (Zelena)
            if (lower.includes("normaln")) return "status--normalno";

            return "status--nema-podataka";
        }

        async function loadData() {
            const loading = document.getElementById('loadingState');
            const error = document.getElementById('errorState');
            const table = document.getElementById('dataTable');

            try {
                // Show loading
                loading.style.display = 'block';
                error.style.display = 'none';
                table.style.display = 'none';

                // Fetch config first
                const configResponse = await fetch('config.json?t=' + Date.now());
                if (!configResponse.ok) throw new Error("Ne mogu učitati konfiguraciju");
                const config = await configResponse.json();
                const csvUrl = config.dataSources.dionice;

                // Fetch directly from Google Sheets
                const response = await fetch(csvUrl + '&t=' + Date.now());
                if (!response.ok) throw new Error("Ne mogu dohvatiti podatke (Google Sheets)");
                const text = await response.text();
                const data = parseCSV(text);

                // Get Slide ID from URL (consistent with meteo.html)
                const urlParams = new URLSearchParams(window.location.search);
                const slideId = urlParams.get('id');

                // Filter data if slideId is present
                let filtered = data;
                if (slideId) {
                    filtered = data.filter(row => row.SLAJD === slideId);
                }

                renderTable(filtered);

                // Show data
                loading.style.display = 'none';
                table.style.display = 'table';

            } catch (e) {
                console.error("Error loading data:", e);
                loading.style.display = 'none';
                error.style.display = 'block';
                document.getElementById('errorMsg').textContent = e.message || "Provjerite internetsku vezu.";
            }
        }

        function renderTable(rows) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";

            rows.forEach(row => {
                // Konverzija CSV zaglavlja: 
                // "OZNAKAE PODRUČJA" -> "OZNAKA PODRUČJA" (kako je korisnik tražio promjenu u čitanju ili pretpostavka da je CSV ispravljen)
                // Ako CSV i dalje šalje "OZNAKAE", trebamo provjeriti oboje za sigurnost, ili se prebaciti na novo.
                // Pretpostavit ćemo da se stupac u CSV-u sada zove "OZNAKA PODRUČJA" ili ćemo podržati oboje.

                const oznaka = row['OZNAKA PODRUČJA'] || row['OZNAKAE PODRUČJA'];
                const vodotok = row['VODOTOK'];

                // Skip invalid rows
                if (!oznaka && !vodotok) return;

                const postaja = row['MJERODAVNI VODOMJER'] || "";
                const kriterij = row['KRITERIJ ZA PROGLAŠENJE MJERA'] || "";

                const rukovoditelj = row['RUKOVODITELJ'] || "";
                const zamjenik = row['ZAMJENIK RUKOVODITELJA'] || "";

                const vodocuvari = row['VODOČUVARI'] || "";

                // Status dionice, ako postoji
                const statusText = row['STATUS'] || "";
                const statusClass = getStatusClass(statusText);

                const tr = document.createElement('tr');

                tr.innerHTML = `
        <td data-label="Dionica / Vodotok">
          <div class="station dionica-code">${oznaka}</div>
          <div class="station__dionica vodotok-name">${vodotok}</div>
        </td>
        <td class="text-left" data-label="Status">
             ${statusText ? `<span class="status ${statusClass}">${statusText}</span>` : ''}
        </td>
        <td data-label="Mjerodavna Postaja">
          <strong class="postaja-name">${postaja}</strong>
        </td>
        <td data-label="Kriterij">
          <span class="kriterij-text">${kriterij}</span>
        </td>
        <td data-label="Rukovodstvo">
          <div class="person-lead">${rukovoditelj}</div>
          ${zamjenik ? `<div class="person-sub" style="margin-top: 0.1rem; color: var(--text-muted);">${zamjenik}</div>` : ''}
        </td>
        <td class="person-sub text-left" data-label="Vodočuvari">${vodocuvari}</td>
      `;
                tbody.appendChild(tr);
            });
        }

        loadData();
        setInterval(loadData, 60000); 
    </script>
</body>

</html>