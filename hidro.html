<!DOCTYPE html>
<html lang="hr">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="refresh" content="3600" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>COPOS – Hidro Podaci</title>
    <link rel="stylesheet" href="style.css" />
    <meta name="theme-color" content="#0b1118">
</head>

<body>
    <div class="app">

        <!-- HEADER -->
        <header class="header">
            <div>
                <div class="header__title" id="pageTitle">VODOTOK</div>
                <div class="header__subtitle">Trenutni vodostaji – mjerodavne postaje</div>
            </div>
        </header>

        <!-- CONTENT -->
        <main class="content">
            <!-- Loading State -->
            <div id="loadingState" class="state-container">
                <div class="spinner"></div>
                <div class="state-title">Učitavanje podataka...</div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="state-container" style="display: none;">
                <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <div class="state-title">Greška</div>
                <div class="state-desc" id="errorMsg">Nije moguće dohvatiti podatke.</div>
                <button class="btn-retry" onclick="loadData()">Pokušaj ponovno</button>
            </div>

            <div class="grid-table hidro-grid" id="dataTable" style="display: none;">
                <div class="grid-header">
                    <div class="col-station">Postaja</div>
                    <div class="col-level text-right">Vodostaj</div>
                    <div class="col-time">Zadnje očitanje</div>
                    <div class="col-trend">Trend</div>
                    <div class="col-status">Status obrane</div>
                </div>

                <div class="grid-body" id="tableBody">
                    <!-- Rows will be populated by JS -->
                </div>
            </div>
        </main>



    </div>

    <!-- Uključujemo naš parser za CSV -->
    <script src="js/csv-parser.js"></script>
    <script>
        /**
         * Pomoćna funkcija: Određuje boju statusa
         * @param {string} statusText - Tekst iz CSV-a (npr. "Redovna obrana")
         * @returns {string} Ime CSS klase koja definira boju
         */
        function getStatusClass(statusText) {
            if (!statusText) return "";
            const lower = statusText.toLowerCase(); // Pretvaramo u mala slova za lakšu usporedbu

            // Redoslijed je važan zbog preklapanja riječi (npr. izvanredno sadrži izvanredn)

            // 1. IZVANREDNO STANJE (Najjače - Ljubičasta)
            if (lower.includes("izvanredno")) return "status--izvanredno";

            // 2. IZVANREDNE MJERE / IZVANREDNA OBRANA (Crvena)
            // Matchevi: "izvanredne", "izvanredna"
            if (lower.includes("izvanredn")) return "status--izvanredna";

            // 3. REDOVNE MJERE / REDOVNA OBRANA (Narančasta)
            // Matchevi: "redovne", "redovna"
            if (lower.includes("redovn")) return "status--redovna";

            // 4. PRIPREMNO STANJE (Žuta)
            // Matchevi: "pripremno", "priprema"
            if (lower.includes("pripremno") || lower.includes("pripremn")) return "status--pripremno";

            // 5. NORMALNO STANJE (Zelena)
            if (lower.includes("normaln")) return "status--normalno";

            return "status--nema-podataka";
        }

        /**
         * Pomoćna funkcija: Formatira prikaz trenda (raste/pada)
         * Dodaje strelice i boje ovisno o vrijednosti.
         */
        function formatTrend(trendVal) {
            if (!trendVal) return `<span class="trend trend--stable">—</span>`;

            // Čišćenje podataka: Zamijeni čudne minuse (-) standardnim i makni sve što nije broj
            let cleanVal = trendVal.toString().replace(/[\u2212\u2013\u2014]/g, "-").replace(/[^\d+-]/g, "");
            const val = parseInt(cleanVal, 10); // Pretvori string u cijeli broj

            if (isNaN(val)) {
                return `<span class="trend trend--stable">—</span>`;
            }

            if (val > 0) {
                // Pozitivan trend (Raste)
                return `<span class="trend trend--up">▲ raste +${val} cm</span>`;
            } else if (val < 0) {
                // Negativan trend (Opada)
                return `<span class="trend trend--down">▼ opada ${val} cm</span>`;
            } else {
                // Nula (Stabilno)
                return `<span class="trend trend--stable">— stabilno</span>`;
            }
        }

        /**
         * GLAVNA FUNKCIJA ZA UČITAVANJE PODATAKA
         * async/await se koristi za asinkrone operacije (čekanje na odgovor servera)
         */
        async function loadData() {
            // Dohvati HTML elemente za UI stanja
            const loading = document.getElementById('loadingState');
            const error = document.getElementById('errorState');
            const table = document.getElementById('dataTable');

            try {
                // 1. Prikaži spinner, sakrij grešku i tablicu
                loading.style.display = 'block';
                error.style.display = 'none';
                table.style.display = 'none';

                // 2. Učitaj konfiguraciju da saznamo URL podataka
                const configResponse = await fetch('config.json?t=' + Date.now());
                if (!configResponse.ok) throw new Error("Ne mogu učitati konfiguraciju");

                const config = await configResponse.json();
                const csvUrl = config.dataSources.hidro; // URL za hidrologiju

                // 3. Dohvati podatke s Google Sheets-a
                const response = await fetch(csvUrl + '&t=' + Date.now());
                if (!response.ok) throw new Error("Ne mogu dohvatiti podatke (Google Sheets)");

                const text = await response.text(); // Pretvori odgovor u tekst
                const data = parseCSV(text);        // Parsiraj tekst u objekte

                // 4. Saznaj koji slajd trebamo prikazati (iz URL-a, npr. ?id=1)
                const urlParams = new URLSearchParams(window.location.search);
                const slideId = urlParams.get('id'); // e.g. "1"

                // 5. Filtriraj samo podatke za taj slajd
                const filtered = data.filter(row => row.SLAJD === slideId);

                // 6. Iscrtaj tablicu
                renderTable(filtered);

                // Ažuriraj naslov ako imamo podataka
                if (filtered.length > 0) {
                    const title = "HIDROLOŠKI PODACI";
                    document.getElementById('pageTitle').textContent = title;
                }

                // 7. Prikaži tablicu
                loading.style.display = 'none';
                table.style.display = 'grid'; // Grid display

            } catch (e) {
                // Ako bilo što krene po zlu, prikaži grešku
                console.error("Greška pri učitavanju:", e);
                loading.style.display = 'none';
                error.style.display = 'block';
                document.getElementById('errorMsg').textContent = e.message || "Provjerite internetsku vezu.";
            }
        }

        /**
         * Iscrtava redove u HTML tablici na temelju podataka.
         */
        function renderTable(rows) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = ""; // Očisti stare redove

            rows.forEach(row => {
                // Za svaki red podataka kreiramo novi HTML div element (grid-row)
                const tr = document.createElement('div');
                tr.className = 'grid-row';

                // Izračunaj klasu za boju na temelju statusa
                const statusClass = getStatusClass(row.STATUS);
                // Formatiraj trend
                const trendHtml = formatTrend(row.TREND);

                // Popuni HTML unutar reda koristeći Template Literals (``)
                tr.innerHTML = `
        <div class="cell-station" data-label="Postaja / Dionica">
          <div class="station">${row.POSTAJA}</div>
          <div class="station__dionica">${row.DIONICE}</div>
        </div>
        <div class="cell-level text-right" data-label="Vodostaj">
          <span class="value">${row.VODOSTAJ}</span><span class="unit">cm</span>
        </div>
        <div class="cell-time time" data-label="Zadnje očitanje">
          ${row.DATUM}<br>${row.VRIJEME}
        </div>
        <div class="cell-trend" data-label="Trend">
          ${trendHtml}
        </div>
        <div class="cell-status" data-label="Status obrane">
          <span class="status ${statusClass}">${row.STATUS || "NEMA PODATAKA"}</span>
        </div>
      `;
                // Dodaj red u tijelo tablice
                tbody.appendChild(tr);
            });
        }

        // Pokreni učitavanje pri startu
        loadData();

        // Osvježi podatke automatski svake minute (60000 ms)
        setInterval(loadData, 60000);
    </script>
</body>

</html>