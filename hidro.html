<!DOCTYPE html>
<html lang="hr">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="refresh" content="3600" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>COPOS – Hidro Podaci</title>
    <link rel="stylesheet" href="style.css" />
    <meta name="theme-color" content="#0b1118">
</head>

<body>
    <div class="app">

        <!-- HEADER -->
        <header class="header">
            <div>
                <div class="header__title" id="pageTitle">VODOTOK</div>
                <div class="header__subtitle">Trenutni vodostaji – mjerodavne postaje</div>
            </div>
        </header>

        <!-- CONTENT -->
        <main class="content">
            <table class="table">
                <thead>
                    <tr>
                        <th>Postaja</th>
                        <th class="text-right">Vodostaj</th>
                        <th>Zadnje očitanje</th>
                        <th>Trend</th>
                        <th>Status obrane</th>
                    </tr>
                </thead>

                <tbody id="tableBody">
                    <!-- Rows will be populated by JS -->
                </tbody>
            </table>
        </main>



    </div>

    <script src="js/csv-parser.js"></script>
    <script>
        // Helper to map status text to CSS classes
        function getStatusClass(statusText) {
            if (!statusText) return "";
            const lower = statusText.toLowerCase();
            if (lower.includes("pripremno")) return "status--pripremno";
            if (lower.includes("redovna")) return "status--redovna";
            if (lower.includes("izvanredna")) return "status--izvanredna";
            if (lower.includes("izvanredno")) return "status--izvanredno";
            if (lower.includes("normalno")) return "status--normalno";
            return "status--nema-podataka";
        }

        // Helper to format trend
        function formatTrend(trendVal) {
            if (!trendVal) return `<span class="trend trend--stable">—</span>`;

            // Replace U+2212 (HTML entity &minus;) or other fancy minus signs with standard hyphen
            // Also remove 'cm' or whitespace if present
            let cleanVal = trendVal.toString().replace(/[\u2212\u2013\u2014]/g, "-").replace(/[^\d+-]/g, "");

            const val = parseInt(cleanVal, 10);

            if (isNaN(val)) {
                // If it's explicitly "0" but parseInt failed (unlikely) or just garbage
                if (cleanVal.trim() === "0") return `<span class="trend trend--stable">— stabilno</span>`;
                return `<span class="trend trend--stable">—</span>`;
            }

            if (val > 0) {
                // Force plus sign for positive numbers
                return `<span class="trend trend--up">▲ raste +${val} cm</span>`;
            } else if (val < 0) {
                // Keep the minus sign in the number for display (e.g. "opada -3 cm")
                // consistent with previous design "opada −3 cm"
                return `<span class="trend trend--down">▼ opada ${val} cm</span>`;
            } else {
                return `<span class="trend trend--stable">— stabilno</span>`;
            }
        }

        async function loadData() {
            try {
                // Fetch directly from Google Sheets
                const response = await fetch('https://docs.google.com/spreadsheets/d/1LcHVJVuSduu9fOkGEIObntiJAKp9GJxHb64YLGca3eA/export?format=csv&t=' + Date.now());
                const text = await response.text();
                const data = parseCSV(text);

                // Get Slide ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const slideId = urlParams.get('id'); // e.g. "1"

                // Filter data
                const filtered = data.filter(row => row.SLAJD === slideId);

                renderTable(filtered);

                // Update Title/Footer if possible. 
                // Since CSV doesn't explicitly have "Vodotok Name" for the whole slide, 
                // we might infer it from the first row or just use generic "VODOTOK " + slideId
                if (filtered.length > 0) {
                    // Improve this if user provides mapping, for now:
                    const title = "HIDROLOŠKI PODACI";
                    document.getElementById('pageTitle').textContent = title;
                    document.getElementById('footerLabel').textContent = title;
                }

            } catch (e) {
                console.error("Error loading data:", e);
            }
        }

        function renderTable(rows) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";

            rows.forEach(row => {
                // CSV Cols: SLAJD,POSTAJA,DATUM,VRIJEME,VODOSTAJ,TREND,DIONICE,STATUS

                const tr = document.createElement('tr');
                // Logic for critical/alert rows could be added if CSV has that info.
                // For now, simple render.

                const statusClass = getStatusClass(row.STATUS);

                // Trend HTML
                const trendHtml = formatTrend(row.TREND);

                tr.innerHTML = `
        <td>
          <div class="station">${row.POSTAJA}</div>
          <div class="station__dionica">${row.DIONICE}</div>
        </td>
        <td class="text-right">
          <span class="value">${row.VODOSTAJ}</span><span class="unit">cm</span>
        </td>
        <td class="time">
          ${row.DATUM}<br>${row.VRIJEME}
        </td>
        <td>
          ${trendHtml}
        </td>
        <td>
          <span class="status ${statusClass}">${row.STATUS || "NEMA PODATAKA"}</span>
        </td>
      `;
                tbody.appendChild(tr);
            });
        }

        loadData();

        // Clock logic if needed, but inner pages usually don't have the clock, index.html does.
        // Original vodotok-1.html had updateClock() script but NO clock element in header (it's in index.html).
        // Wait, vodotok-1.html DOES have <script> updateClock... but check the HTML...
        // vodotok-1.html: <div class="clock" id="clock"> is MISSING in header HTML in vodotok-1.html.
        // The header in vodotok-1.html is:
        /*
        <header class="header">
          <div>
            <div class="header__title">VODOTOK 1</div>...
          </div>
        </header>
        */
        // So the clock script in vodotok-1.html was likely redundant or dead code effectively.
        // I will skip the clock here.

    </script>
    <script>
        // Auto refresh every 5 mins to fetch new CSV data without full page reload if desired, 
        // but <meta http-equiv="refresh" content="3600" /> is already there (1 hour).
        // Let's add a soft data reload every 60 seconds just in case.
        setInterval(loadData, 60000);
    </script>
</body>

</html>