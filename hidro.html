<!DOCTYPE html>
<html lang="hr">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="refresh" content="3600" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>COPOS – Hidro Podaci</title>
    <link rel="stylesheet" href="style.css" />
    <meta name="theme-color" content="#0b1118">
</head>

<body>
    <div class="app">

        <!-- HEADER -->
        <header class="header">
            <div>
                <div class="header__title" id="pageTitle">VODOTOK</div>
                <div class="header__subtitle">Trenutni vodostaji – mjerodavne postaje</div>
            </div>
        </header>

        <!-- CONTENT -->
        <main class="content">
            <!-- Loading State -->
            <div id="loadingState" class="state-container">
                <div class="spinner"></div>
                <div class="state-title">Učitavanje podataka...</div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="state-container" style="display: none;">
                <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <div class="state-title">Greška</div>
                <div class="state-desc" id="errorMsg">Nije moguće dohvatiti podatke.</div>
                <button class="btn-retry" onclick="loadData()">Pokušaj ponovno</button>
            </div>

            <table class="table" id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Postaja</th>
                        <th class="text-right">Vodostaj</th>
                        <th>Zadnje očitanje</th>
                        <th>Trend</th>
                        <th>Status obrane</th>
                    </tr>
                </thead>

                <tbody id="tableBody">
                    <!-- Rows will be populated by JS -->
                </tbody>
            </table>
        </main>



    </div>

    <script src="js/csv-parser.js"></script>
    <script>
        // Helper to map status text to CSS classes
        function getStatusClass(statusText) {
            if (!statusText) return "";
            const lower = statusText.toLowerCase();
            if (lower.includes("pripremno")) return "status--pripremno";
            if (lower.includes("redovna")) return "status--redovna";
            if (lower.includes("izvanredna")) return "status--izvanredna";
            if (lower.includes("izvanredno")) return "status--izvanredno";
            if (lower.includes("normalno")) return "status--normalno";
            return "status--nema-podataka";
        }

        // Helper to format trend
        function formatTrend(trendVal) {
            if (!trendVal) return `<span class="trend trend--stable">—</span>`;

            // Replace U+2212 (HTML entity &minus;) or other fancy minus signs with standard hyphen
            // Also remove 'cm' or whitespace if present
            let cleanVal = trendVal.toString().replace(/[\u2212\u2013\u2014]/g, "-").replace(/[^\d+-]/g, "");

            const val = parseInt(cleanVal, 10);

            if (isNaN(val)) {
                // If it's explicitly "0" but parseInt failed (unlikely) or just garbage
                if (cleanVal.trim() === "0") return `<span class="trend trend--stable">— stabilno</span>`;
                return `<span class="trend trend--stable">—</span>`;
            }

            if (val > 0) {
                // Force plus sign for positive numbers
                return `<span class="trend trend--up">▲ raste +${val} cm</span>`;
            } else if (val < 0) {
                // Keep the minus sign in the number for display (e.g. "opada -3 cm")
                // consistent with previous design "opada −3 cm"
                return `<span class="trend trend--down">▼ opada ${val} cm</span>`;
            } else {
                return `<span class="trend trend--stable">— stabilno</span>`;
            }
        }

        async function loadData() {
            const loading = document.getElementById('loadingState');
            const error = document.getElementById('errorState');
            const table = document.getElementById('dataTable');

            try {
                // Show loading
                loading.style.display = 'block';
                error.style.display = 'none';
                table.style.display = 'none';

                // Fetch config first
                const configResponse = await fetch('config.json?t=' + Date.now());
                if (!configResponse.ok) throw new Error("Ne mogu učitati konfiguraciju");
                const config = await configResponse.json();
                const csvUrl = config.dataSources.hidro;

                // Fetch directly from Google Sheets
                const response = await fetch(csvUrl + '&t=' + Date.now());
                if (!response.ok) throw new Error("Ne mogu dohvatiti podatke (Google Sheets)");
                const text = await response.text();
                const data = parseCSV(text);

                // Get Slide ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const slideId = urlParams.get('id'); // e.g. "1"

                // Filter data
                const filtered = data.filter(row => row.SLAJD === slideId);

                renderTable(filtered);

                // Update Title/Footer if possible. 
                if (filtered.length > 0) {
                    const title = "HIDROLOŠKI PODACI";
                    document.getElementById('pageTitle').textContent = title;
                }

                // Show data
                loading.style.display = 'none';
                table.style.display = 'table';

            } catch (e) {
                console.error("Error loading data:", e);
                loading.style.display = 'none';
                error.style.display = 'block';
                document.getElementById('errorMsg').textContent = e.message || "Provjerite internetsku vezu.";
            }
        }

        function renderTable(rows) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";

            rows.forEach(row => {
                // CSV Cols: SLAJD,POSTAJA,DATUM,VRIJEME,VODOSTAJ,TREND,DIONICE,STATUS

                const tr = document.createElement('tr');
                // Logic for critical/alert rows could be added if CSV has that info.
                // For now, simple render.

                const statusClass = getStatusClass(row.STATUS);

                // Trend HTML
                const trendHtml = formatTrend(row.TREND);

                tr.innerHTML = `
        <td>
          <div class="station">${row.POSTAJA}</div>
          <div class="station__dionica">${row.DIONICE}</div>
        </td>
        <td class="text-right">
          <span class="value">${row.VODOSTAJ}</span><span class="unit">cm</span>
        </td>
        <td class="time">
          ${row.DATUM}<br>${row.VRIJEME}
        </td>
        <td>
          ${trendHtml}
        </td>
        <td>
          <span class="status ${statusClass}">${row.STATUS || "NEMA PODATAKA"}</span>
        </td>
      `;
                tbody.appendChild(tr);
            });
        }

        loadData();

        // Clock logic if needed, but inner pages usually don't have the clock, index.html does.
        // Original vodotok-1.html had updateClock() script but NO clock element in header (it's in index.html).
        // Wait, vodotok-1.html DOES have <script> updateClock... but check the HTML...
        // vodotok-1.html: <div class="clock" id="clock"> is MISSING in header HTML in vodotok-1.html.
        // The header in vodotok-1.html is:
        /*
        <header class="header">
          <div>
            <div class="header__title">VODOTOK 1</div>...
          </div>
        </header>
        */
        // So the clock script in vodotok-1.html was likely redundant or dead code effectively.
        // I will skip the clock here.

    </script>
    <script>
        // Auto refresh every 5 mins to fetch new CSV data without full page reload if desired, 
        // but <meta http-equiv="refresh" content="3600" /> is already there (1 hour).
        // Let's add a soft data reload every 60 seconds just in case.
        setInterval(loadData, 60000);
    </script>
</body>

</html>