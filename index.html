<!DOCTYPE html>
<html lang="hr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>COPOS – Pregled vodostaja</title>
  <link rel="stylesheet" href="style.css" />

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b1118">
</head>

<body>
  <div class="app">
    <!-- Global Error Overlay -->
    <div id="globalError" class="state-container" style="display: none; z-index: 1000; background: var(--bg-main);">
      <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <div class="state-title">Greška u inicijalizaciji</div>
      <div class="state-desc" id="globalErrorMsg">Nije moguće učitati konfiguraciju.</div>
      <button class="btn-retry" onclick="location.reload()">Pokušaj ponovno</button>
    </div>

    <header class="header">
      <div>
        <div class="header__title">CENTAR OBRANE OD POPLAVA – OSIJEK</div>
        <div class="header__subtitle">INFO PANEL</div>
      </div>

      <div class="clock" id="clock">--:--:--</div>
    </header>

    <main class="content content--no-padding">
      <iframe id="slideFrame" src="hidro.html?id=1" class="iframe--fullscreen" loading="eager"></iframe>
    </main>

    <footer class="footer">
      <div>Izvor: Hrvatske vode / DHMZ / SHMU / OVF</div>

      <div class="rotation">
        <button id="prevSlide" class="rotation__toggle" aria-label="Prethodni slajd" title="Prethodni slajd">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
            <path d="M9 2L4 7L9 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" fill="none" />
          </svg>
        </button>

        <button id="rotationToggle" class="rotation__toggle" aria-label="Pauziraj rotaciju" title="Pauziraj">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
            <rect x="2" y="1" width="4" height="12" rx="1" />
            <rect x="8" y="1" width="4" height="12" rx="1" />
          </svg>
        </button>

        <button id="nextSlide" class="rotation__toggle" aria-label="Sljedeći slajd" title="Sljedeći slajd">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
            <path d="M5 2L10 7L5 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" fill="none" />
          </svg>
        </button>

        <span id="slideLabel">VODOTOK - POSTAJA</span>

        <div class="progress">
          <div class="progress__bar" id="progressBar"></div>
        </div>

        <span id="slideCounter">1 / 31</span>
      </div>
    </footer>

  </div>

  <script>
    /* ================================
       SAT
    ================================ */
    function updateClock() {
      document.getElementById("clock")
        .textContent = new Date().toLocaleTimeString("hr-HR");
    }
    updateClock();
    setInterval(updateClock, 1000);

    /* ================================
       ROTACIJA SLAJDOVA
    ================================ */
    let slides = [];
    let rotationTime = 12000; // 12 sekundi
    let currentSlide = 0;
    let rotationInterval = null;
    let progressAnimationFrame = null;
    let isPaused = false;
    let progressStartTime = null;

    const frame = document.getElementById("slideFrame");
    const label = document.getElementById("slideLabel");
    const counter = document.getElementById("slideCounter");
    const bar = document.getElementById("progressBar");
    const toggleBtn = document.getElementById("rotationToggle");

    // SVG ikone
    const ICON_PAUSE = `
      <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
        <rect x="2" y="1" width="4" height="12" rx="1" />
        <rect x="8" y="1" width="4" height="12" rx="1" />
      </svg>`;

    const ICON_PLAY = `
      <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor" class="icon--offset">
        <path d="M3 2.5C3 1.6 4 1.1 4.8 1.6L12.3 6.1C13 6.5 13 7.5 12.3 7.9L4.8 12.4C4 12.9 3 12.4 3 11.5V2.5Z" />
      </svg>`;

    // Učitaj slajd
    function loadSlide(index) {
      if (slides.length === 0) return;
      currentSlide = index % slides.length;
      const slide = slides[currentSlide];

      frame.src = slide.src;
      label.textContent = slide.label;
      counter.textContent = `${currentSlide + 1} / ${slides.length}`;

      // Odredi trajanje za ovaj slajd (override ako postoji u configu za taj slajd, inače default)
      const duration = slide.duration || rotationTime;

      // Resetiraj progress bar
      bar.style.transition = "none";
      bar.style.width = "0%";

      if (!isPaused) {
        // Ponovno pokreni timer s novim trajanjem
        if (rotationInterval) clearInterval(rotationInterval);
        rotationInterval = setInterval(nextSlide, duration);

        // Animiraj progress bar
        requestAnimationFrame(() => {
          bar.style.transition = `width ${duration}ms linear`;
          bar.style.width = "100%";
        });
      }
    }

    // Sljedeći slajd
    function nextSlide() {
      loadSlide(currentSlide + 1);
    }

    // Prethodni slajd
    function previousSlide() {
      loadSlide(currentSlide - 1 + slides.length);
    }

    // Pokreni rotaciju
    function startRotation() {
      if (rotationInterval) clearInterval(rotationInterval);

      const slide = slides[currentSlide];
      const duration = (slide && slide.duration) || rotationTime;

      rotationInterval = setInterval(nextSlide, duration);
      isPaused = false;

      toggleBtn.innerHTML = ICON_PAUSE;
      toggleBtn.setAttribute("aria-label", "Pauziraj rotaciju");
      toggleBtn.setAttribute("title", "Pauziraj");

      // Restart progress bar
      bar.style.transition = "none";
      bar.style.width = "0%";
      requestAnimationFrame(() => {
        bar.style.transition = `width ${duration}ms linear`;
        bar.style.width = "100%";
      });
    }

    // Zaustavi rotaciju
    function stopRotation() {
      if (rotationInterval) {
        clearInterval(rotationInterval);
        rotationInterval = null;
      }

      isPaused = true;

      toggleBtn.innerHTML = ICON_PLAY;
      toggleBtn.setAttribute("aria-label", "Pokreni rotaciju");
      toggleBtn.setAttribute("title", "Pokreni");

      // Zamrzni progress bar na trenutnoj poziciji
      const computedStyle = window.getComputedStyle(bar);
      const width = computedStyle.getPropertyValue('width');
      bar.style.transition = "none";
      bar.style.width = width;
    }

    // Toggle pauza/play
    function toggleRotation() {
      if (isPaused) {
        startRotation();
      } else {
        stopRotation();
      }
    }

    // Event listeneri
    toggleBtn.addEventListener("click", toggleRotation);

    document.getElementById("prevSlide").addEventListener("click", () => {
      previousSlide();
    });

    document.getElementById("nextSlide").addEventListener("click", () => {
      nextSlide();
    });

    // Keyboard shortcuts
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") {
        previousSlide();
      } else if (e.key === "ArrowRight") {
        nextSlide();
      } else if (e.key === " " || e.key === "Spacebar") {
        e.preventDefault();
        toggleRotation();
      }
    });

    // Inicijalizacija
    async function init() {
      try {
        const response = await fetch('config.json?t=' + Date.now());
        const config = await response.json();

        slides = config.rotation.slides;
        rotationTime = config.rotation.defaultDuration || 12000;

        // Update title if present
        if (config.app) {
          if (config.app.title) document.querySelector('.header__title').textContent = config.app.title;
          if (config.app.subtitle) document.querySelector('.header__subtitle').textContent = config.app.subtitle;
        }

        console.log(`Loaded ${slides.length} slides from config.`);

        loadSlide(0);
        // Start automatically
        // startRotation is called inside loadSlide logic mostly, but we trigger the first interval:
        // Actually loadSlide handles bar animation, but we need to ensure interval calls nextSlide.
        // Let's explicitly start it.
        // Note: loadSlide doesn't start interval if isPaused is true.
        // Intially isPaused is false.

        // However, loadSlide logic above has: 
        // if (!isPaused) { clearInterval; setInterval; }
        // So calling loadSlide(0) will start the rotation if isPaused is false.

      } catch (error) {
        console.error("Failed to load config.json", error);
        // Show global error
        document.getElementById('globalError').style.display = 'block';
        document.getElementById('globalErrorMsg').textContent = "Nije moguće učitati konfiguraciju (config.json).";
        label.textContent = "GREŠKA";
      }
    }

    init();

    // Debugging info (može se ukloniti u produkciji)
    console.log(`Rotacija pokrenuta: ${slides.length} slajdova × ${rotationTime / 1000}s = ${(slides.length * rotationTime) / 60000} min`);
  </script>

</body>

</html>