<!DOCTYPE html>
<html lang="hr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>COPOS – Pregled vodostaja</title>
  <link rel="stylesheet" href="style.css" />

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b1118">
</head>

<body>
  <div class="app">
    <!-- Global Error Overlay -->
    <div id="globalError" class="state-container" style="display: none; z-index: 1000; background: var(--bg-main);">
      <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <div class="state-title">Greška u inicijalizaciji</div>
      <div class="state-desc" id="globalErrorMsg">Nije moguće učitati konfiguraciju.</div>
      <button class="btn-retry" onclick="location.reload()">Pokušaj ponovno</button>
    </div>

    <header class="header">
      <div>
        <div class="header__title">CENTAR OBRANE OD POPLAVA – OSIJEK</div>
        <div class="header__subtitle">INFO PANEL</div>
      </div>

      <div class="clock" id="clock">--:--:--</div>
    </header>

    <main class="content content--no-padding">
      <iframe id="slideFrame" src="hidro.html?id=1" class="iframe--fullscreen" loading="eager"></iframe>
    </main>

    <footer class="footer">
      <div>Izvor: Hrvatske vode / DHMZ / SHMU / OVF</div>

      <div class="rotation">
        <button id="prevSlide" class="rotation__toggle" aria-label="Prethodni slajd" title="Prethodni slajd">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
            <path d="M9 2L4 7L9 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" fill="none" />
          </svg>
        </button>

        <button id="rotationToggle" class="rotation__toggle" aria-label="Pauziraj rotaciju" title="Pauziraj">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
            <rect x="2" y="1" width="4" height="12" rx="1" />
            <rect x="8" y="1" width="4" height="12" rx="1" />
          </svg>
        </button>

        <button id="nextSlide" class="rotation__toggle" aria-label="Sljedeći slajd" title="Sljedeći slajd">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
            <path d="M5 2L10 7L5 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" fill="none" />
          </svg>
        </button>

        <span id="slideLabel">VODOTOK - POSTAJA</span>

        <div class="progress">
          <div class="progress__bar" id="progressBar"></div>
        </div>

        <span id="slideCounter">1 / 31</span>
      </div>
    </footer>

  </div>

  <script>
    /* ==========================================================================
       GLAVNA SKRIPTA ZA UPRAVLJANJE APLIKACIJOM
       
       Ovaj dio koda upravlja rotacijom slajdova, satom i učitavanjem postavki.
       Koristimo "Vanilla JavaScript" (čisti JS bez frameworka) jer je brži
       i jednostavniji za ovakve projekte.
    ========================================================================== */

    /* --------------------------------------------------------------------------
       1. DEFINICIJA VARIJABLI (Stanje aplikacije)
       Ovdje pamtimo trenutno stanje: koji je slajd prikazan, je li pauzirano itd.
    -------------------------------------------------------------------------- */
    let slides = [];              // Lista slajdova koju ćemo učitati iz config.json
    let rotationTime = 12000;     // Zadano vrijeme trajanja slajda u milisekundama (12s)
    let currentSlide = 0;         // Indeks trenutnog slajda (kreće od 0)
    let rotationInterval = null;  // Varijabla koja čuva referencu na timer za rotaciju
    let isPaused = false;         // Zastavica: true ako je korisnik pauzirao rotaciju

    // Dohvaćamo HTML elemente s kojima ćemo manipulirati
    // const (konstanta) koristimo jer se referenca na element neće mijenjati
    const frame = document.getElementById("slideFrame");       // Iframe u kojem se prikazuje sadržaj
    const label = document.getElementById("slideLabel");       // Naslov slajda u footeru
    const counter = document.getElementById("slideCounter");   // Brojač (npr. 1 / 10)
    const bar = document.getElementById("progressBar");        // Linija koja pokazuje napredak
    const toggleBtn = document.getElementById("rotationToggle"); // Gumb za pauzu/start

    // Definiramo SVG ikone kao stringove kako ne bismo morali imati vanjske slike
    const ICON_PAUSE = `
      <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
        <rect x="2" y="1" width="4" height="12" rx="1" />
        <rect x="8" y="1" width="4" height="12" rx="1" />
      </svg>`;

    const ICON_PLAY = `
      <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor" class="icon--offset">
        <path d="M3 2.5C3 1.6 4 1.1 4.8 1.6L12.3 6.1C13 6.5 13 7.5 12.3 7.9L4.8 12.4C4 12.9 3 12.4 3 11.5V2.5Z" />
      </svg>`;

    /* --------------------------------------------------------------------------
       2. FUNKCIJE ZA SAT
       Osvježava sat svake sekunde.
    -------------------------------------------------------------------------- */
    function updateClock() {
      // Dohvaćamo trenutno vrijeme i formatiramo ga na hrvatski način (hr-HR)
      document.getElementById("clock")
        .textContent = new Date().toLocaleTimeString("hr-HR");
    }
    updateClock(); // Pozovi odmah jedanput
    setInterval(updateClock, 1000); // I onda ponavljaj svake sekunde (1000 ms)


    /* --------------------------------------------------------------------------
       3. FUNKCIJE ZA ROTACIJU SLAJDOVA
       Glavna logika za prebacivanje sadržaja u iframe-u.
    -------------------------------------------------------------------------- */

    /**
     * Učitava i prikazuje određeni slajd.
     * @param {number} index - Redni broj slajda koji želimo prikazati
     */
    function loadSlide(index) {
      if (slides.length === 0) return; // Ako nema slajdova, ne radi ništa

      // Koristimo modul operator (%) za kružnu rotaciju.
      // Primjer: ako imamo 5 slajdova, a tražimo 6. slajd (index 5), 
      // 5 % 5 = 0, pa se vraćamo na prvi slajd.
      currentSlide = index % slides.length;

      const slide = slides[currentSlide];

      // Postavljamo izvor (src) iframe-a na novi URL i ažuriramo tekstove
      frame.src = slide.src;
      label.textContent = slide.label;
      counter.textContent = `${currentSlide + 1} / ${slides.length}`;

      // Provjeravamo ima li ovaj specifični slajd svoje trajanje u configu, 
      // ako ne, koristi globalno zadano vrijeme.
      const duration = slide.duration || rotationTime;

      // Resetiramo animaciju progress bara
      bar.style.transition = "none"; // Isključi animaciju da se bar odmah vrati na 0
      bar.style.width = "0%";

      // Ako rotacija nije pauzirana, pokrećemo novu animaciju i timer
      if (!isPaused) {
        // Restartiramo interval (timer) kako bi brojao od nule za novi slajd
        if (rotationInterval) clearInterval(rotationInterval);
        rotationInterval = setInterval(nextSlide, duration);

        // Pokrećemo animaciju širenja progress bara
        // requestAnimationFrame osigurava da se promjena dogodi u sljedećem iscrtavanju ekrana (glađe)
        requestAnimationFrame(() => {
          bar.style.transition = `width ${duration}ms linear`; // Animacija traje točno koliko i slajd
          bar.style.width = "100%"; // Širi se do kraja
        });
      }
    }

    // Funkcija za prelazak na idući slajd
    function nextSlide() {
      loadSlide(currentSlide + 1);
    }

    // Funkcija za povratak na prethodni slajd
    function previousSlide() {
      // Dodajemo slides.length prije oduzimanja kako ne bismo dobili negativan broj
      // (kružna rotacija unazad)
      loadSlide(currentSlide - 1 + slides.length);
    }

    /**
     * Pokreće automatsku rotaciju slajdova.
     */
    function startRotation() {
      // Prvo očistimo stari timer ako postoji da ne bi imali dva timera istovremeno
      if (rotationInterval) clearInterval(rotationInterval);

      const slide = slides[currentSlide];
      const duration = (slide && slide.duration) || rotationTime;

      // Postavi novi timer koji će zvati nextSlide svakih 'duration' milisekundi
      rotationInterval = setInterval(nextSlide, duration);
      isPaused = false;

      // Ažuriraj ikonu na gumbu (prikaži pauzu jer sad vrtimo)
      toggleBtn.innerHTML = ICON_PAUSE;
      toggleBtn.setAttribute("aria-label", "Pauziraj rotaciju");
      toggleBtn.setAttribute("title", "Pauziraj");

      // Pokreni animaciju progress bara
      bar.style.transition = "none";
      bar.style.width = "0%";
      requestAnimationFrame(() => {
        bar.style.transition = `width ${duration}ms linear`;
        bar.style.width = "100%";
      });
    }

    /**
     * Zaustavlja automatsku rotaciju.
     */
    function stopRotation() {
      if (rotationInterval) {
        clearInterval(rotationInterval); // Zaustavi timer
        rotationInterval = null;
      }

      isPaused = true;

      // Ažuriraj ikonu na gumbu (prikaži play jer smo stali)
      toggleBtn.innerHTML = ICON_PLAY;
      toggleBtn.setAttribute("aria-label", "Pokreni rotaciju");
      toggleBtn.setAttribute("title", "Pokreni");

      // "Zamrzni" napredak progress bara na trenutnoj poziciji
      // Ovo radimo tako da izračunamo trenutnu širinu i fiksiramo je
      const computedStyle = window.getComputedStyle(bar);
      const width = computedStyle.getPropertyValue('width');
      bar.style.transition = "none"; // Ukloni animaciju
      bar.style.width = width;       // Ostavi širinu kakva je
    }

    // Funkcija koja se poziva klikom na gumb za pauzu/start
    function toggleRotation() {
      if (isPaused) {
        startRotation();
      } else {
        stopRotation();
      }
    }

    /* --------------------------------------------------------------------------
       4. POSTAVLJANJE OSLUŠKIVAČA DOGAĐAJA (Event Listeners)
       Povezujemo klikove i tipke s funkcijama.
    -------------------------------------------------------------------------- */
    toggleBtn.addEventListener("click", toggleRotation);

    document.getElementById("prevSlide").addEventListener("click", () => {
      previousSlide();
    });

    document.getElementById("nextSlide").addEventListener("click", () => {
      nextSlide();
    });

    // Funkcija za obradu događaja tipkovnice
    function handleKeydown(e) {
      if (e.key === "ArrowLeft") {
        previousSlide();
      } else if (e.key === "ArrowRight") {
        nextSlide();
      } else if (e.key === " " || e.key === "Spacebar") {
        e.preventDefault(); // Spriječi skrolanje stranice kad se stisne Space
        toggleRotation();
      }
    }

    // Podrška za tipkovnicu (strelice i razmaknica) na glavnom prozoru
    document.addEventListener("keydown", handleKeydown);

    // FIX: Iframe preuzima fokus pa tipke ne rade.
    // Ovdje kažemo: "Kad se iframe učita, slušaj tipke i unutar njega."
    frame.addEventListener("load", () => {
      try {
        // Pokušavamo pristupiti dokumentu unutar iframe-a
        const iframeDoc = frame.contentDocument || frame.contentWindow.document;

        // Dodajemo isti osluškivač (handleKeydown) i tamo
        iframeDoc.addEventListener("keydown", handleKeydown);

        // Opcionalno: Klik unutar iframe-a vraća fokus na glavni prozor (ako želimo)
        // iframeDoc.addEventListener("click", () => window.focus());
      } catch (err) {
        // Ovo se može dogoditi ako je iframe s druge domene (CORS zaštita), 
        // ali kod nas su lokalne datoteke pa bi trebalo raditi.
        console.warn("Nije moguće dodati event listener na iframe:", err);
      }
    });

    /* --------------------------------------------------------------------------
       5. INICIJALIZACIJA (Start aplikacije)
       Učitavamo postavke iz JSON datoteke i pokrećemo rotaciju.
    -------------------------------------------------------------------------- */
    async function init() {
      try {
        // Fetch API dohvaća podatke s mreže (ili lokalnog diska)
        // Dodajemo '?t=' + Date.now() kako bismo spriječili "keširanje" 
        // (da preglednik ne pamti staru verziju datoteke)
        const response = await fetch('config.json?t=' + Date.now());

        // Pretvaramo odgovor u JSON objekt
        const config = await response.json();

        // Spremamo podatke iz configa u naše varijable
        slides = config.rotation.slides;
        rotationTime = config.rotation.defaultDuration || 12000;

        // Ako u configu postoje naslovi aplikacije, primijeni ih
        if (config.app) {
          if (config.app.title) document.querySelector('.header__title').textContent = config.app.title;
          if (config.app.subtitle) document.querySelector('.header__subtitle').textContent = config.app.subtitle;
          if (config.app.footerText) document.querySelector('.footer > div:first-child').textContent = config.app.footerText;
          if (config.app.themeColor) {
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme) metaTheme.setAttribute('content', config.app.themeColor);
          }
        }

        console.log(`Učitano ${slides.length} slajdova iz konfiguracije.`);

        // Prikaži prvi slajd
        loadSlide(0);

        // PROVJERA ZA MOBITEL: Ako je ekran uži od 768px, automatski pauziraj
        if (window.innerWidth < 768) {
          stopRotation(); // Pauziraj odmah
          console.log("Mobitel detektiran: Rotacija automatski pauzirana.");
        }
        // Inače, loadSlide će pokrenuti rotaciju ako isPaused nije true (a nije na početku)

      } catch (error) {
        // Ako se dogodi greška (npr. ne nađe config.json), ispiši grešku korisniku
        console.error("Greška pri učitavanju config.json:", error);

        // Prikaži globalni overlay s porukom o grešci
        document.getElementById('globalError').style.display = 'block';
        document.getElementById('globalErrorMsg').textContent = "Nije moguće učitati konfiguraciju (config.json).";
        label.textContent = "GREŠKA";
      }
    }

    // Pokreni inicijalizaciju
    init();

    // Ispis u konzolu za developera
    console.log(`Aplikacija pokrenuta.`);
  </script>

</body>

</html>