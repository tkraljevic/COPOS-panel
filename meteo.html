<!DOCTYPE html>
<html lang="hr">

<head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>COPOS – Meteo Podaci</title>
    <link rel="stylesheet" href="style.css" />
    <meta name="theme-color" content="#0b1118">
</head>

<body>
    <div class="app">

        <!-- Offline Banner -->
        <div id="offlineBanner" class="offline-banner">
            OFFLINE MODE (Prikazuju se zadnji poznati podaci: <span id="offlineTime">-</span>)
        </div>

        <!-- HEADER -->
        <header class="header">
            <div>
                <div class="header__title">METEOROLOŠKI PODACI</div>
                <div class="header__subtitle">Trenutno stanje na postajama</div>
            </div>
        </header>

        <!-- CONTENT -->
        <main class="content">
            <!-- Loading State -->
            <div id="loadingState" class="state-container">
                <div class="spinner"></div>
                <div class="state-title">Učitavanje podataka...</div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="state-container" style="display: none;">
                <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <div class="state-title">Greška</div>
                <div class="state-desc" id="errorMsg">Nije moguće dohvatiti podatke.</div>
                <button class="btn-retry" onclick="loadData()">Pokušaj ponovno</button>
            </div>

            <div class="grid-table meteo-grid" id="dataTable" style="display: none;">
                <!-- Complex Header for Meteo -->
                <div class="grid-header meteo-header-group">
                    <!-- Top Row -->
                    <div class="header-cell cell-loc-head">Lokacija</div>
                    <div class="header-cell cell-time-head">Datum/Vrijeme</div>
                    <div class="header-cell cell-temp-head">Temperatura (°C)</div>
                    <div class="header-cell cell-wind-head">Vjetar (m/s)</div>
                    <div class="header-cell cell-pres-head">Tlak (hPa)</div>
                    <div class="header-cell cell-hum-head">Vlaga (%)</div>
                    <div class="header-cell cell-rain-head">Oborina (mm)</div>

                    <!-- Sub Row (Visual only, or flattened?) -->
                    <!-- Flattening headers for Grid is easier. 
                         Let's just put the sub-headers in the second row of the grid header container?
                         
                         Actually, standard approach:
                         Grid Header Container -> Display Grid (same cols as body).
                         Items for top row span columns.
                         Items for sub row occupy single columns.
                    -->
                </div>
                <!-- Sub-header row for specific columns -->
                <div class="grid-header meteo-subheader">
                    <!-- Empty for Loc/Time/Pres/Hum if they span 2 rows? 
                          Or we just repeat/leave empty?
                          Let's simulate the visual stack.
                     -->
                    <div class="empty"></div> <!-- loc -->
                    <div class="empty"></div> <!-- time -->

                    <div class="text-center">Trenutna</div>
                    <div class="text-center">Min</div>
                    <div class="text-center">Max</div>

                    <div class="text-center">Smjer</div>
                    <div class="text-center">Brzina</div>
                    <div class="text-center">Udari</div>

                    <div class="empty"></div> <!-- pres -->
                    <div class="empty"></div> <!-- hum -->

                    <div class="text-center">Satna</div>
                    <div class="text-center">Dnevna</div>
                    <div class="text-center">Mjes.</div>
                </div>

                <div class="grid-body" id="tableBody">
                    <!-- Rows will be populated by JS -->
                </div>
            </div>
        </main>



    </div>

    <script src="js/csv-parser.js"></script>
    <script>
        async function init() {
            try {
                const response = await fetch('config.json?t=' + Date.now());
                const config = await response.json();

                // 1. App Settings
                if (config.app) {
                    if (config.app.themeColor) {
                        let meta = document.querySelector('meta[name="theme-color"]');
                        if (!meta) {
                            meta = document.createElement('meta');
                            meta.name = "theme-color";
                            document.head.appendChild(meta);
                        }
                        meta.setAttribute('content', config.app.themeColor);
                    }
                    if (config.app.metaRefreshSeconds) {
                        setTimeout(() => location.reload(), config.app.metaRefreshSeconds * 1000);
                    }
                }

                // 2. Page Settings
                if (config.pages && config.pages.meteo) {
                    const p = config.pages.meteo;
                    if (p.browserTitle) document.title = p.browserTitle;
                    if (p.pageTitle) document.querySelector('.header__title').textContent = p.pageTitle;
                    if (p.pageSubtitle) document.querySelector('.header__subtitle').textContent = p.pageSubtitle;
                }

                // 3. Start
                loadData(config);
                const interval = (config.dataSources && config.dataSources.refreshIntervalMs) || 60000;
                setInterval(() => loadData(), interval);

            } catch (e) {
                console.error("Init Error:", e);
            }
        }

        async function loadData(preloadedConfig = null) {
            const loading = document.getElementById('loadingState');
            const error = document.getElementById('errorState');
            const table = document.getElementById('dataTable');
            const offlineBanner = document.getElementById('offlineBanner');
            const offlineTime = document.getElementById('offlineTime');

            // Cache keys based on file name or generic
            const CACHE_KEY_DATA = 'copos_meteo_data';
            const CACHE_KEY_TIME = 'copos_meteo_time';

            /**
             * Učitavanje meteo podataka
             * Specifičnost: Očekuje se puno više stupaca nego kod hidro/dionica.
             */
            try {
                if (table.style.display === 'none') {
                    loading.style.display = 'block';
                }
                error.style.display = 'none';

                let config = preloadedConfig;
                if (!config) {
                    const r = await fetch('config.json?t=' + Date.now());
                    if (!r.ok) throw new Error("Ne mogu učitati konfiguraciju");
                    config = await r.json();
                }

                const csvUrl = config.dataSources.meteo;
                const response = await fetch(csvUrl + '&t=' + Date.now());
                if (!response.ok) throw new Error("Ne mogu dohvatiti podatke (Google Sheets)");
                const text = await response.text();

                // SAVE TO CACHE
                localStorage.setItem(CACHE_KEY_DATA, text);
                localStorage.setItem(CACHE_KEY_TIME, new Date().toLocaleString('hr-HR'));

                // OK -> Hide Offline Banner
                offlineBanner.style.display = 'none';

                processAndRender(text);

                loading.style.display = 'none';
                table.style.display = 'grid';

            } catch (e) {
                console.warn("Network error, trying cache...", e);

                // TRY LOAD FROM CACHE
                const cachedData = localStorage.getItem(CACHE_KEY_DATA);
                const cachedTime = localStorage.getItem(CACHE_KEY_TIME);

                if (cachedData) {
                    console.log("Serving from cache.");
                    offlineBanner.style.display = 'block';
                    offlineTime.textContent = cachedTime || "Nepoznato";

                    processAndRender(cachedData);

                    loading.style.display = 'none';
                    table.style.display = 'grid';
                    error.style.display = 'none';
                } else {
                    // No cache, real error
                    console.error("No cache available:", e);
                    loading.style.display = 'none';
                    error.style.display = 'block';
                    document.getElementById('errorMsg').textContent = e.message || "Provjerite internetsku vezu.";
                }
            }
        }

        function processAndRender(csvText) {
            const data = parseCSV(csvText);

            // Get Slide ID from URL (consistent with meteo.html)
            const urlParams = new URLSearchParams(window.location.search);
            const slideId = urlParams.get('id');

            // Filter data if slideId is present
            let filtered = data;
            if (slideId) {
                filtered = data.filter(row => row.SLAJD === slideId);
            }

            renderTable(filtered);
        }

        /**
         * Renderiranje meteo tablice
         * Ovdje je ključno mapiranje točnih naziva stupaca iz CSV-a.
         * Ako Google Sheets promijeni nazive stupaca, ovo će se morati ažurirati.
         */
        function renderTable(rows) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";

            rows.forEach(row => {
                // CSV Cols: SLAJD,LOKACIJA,DATUM,VRIJEME,TEMPERATURA ZRAKA C°,MIN TEMP. C°,MAX TEMP. C°,SMJER VJETRA,VJETAR [m/s],MAX UDARI VJETRA [m/s],TLAK ZRAKA [hPa],VLAGA [%],SATNA OBORINA [mm],DNEVNA OBORINA [mm],MJESEČNA OBORINA [mm]

                // Map columns
                // NAPOMENA: Koristimo točne nazive iz CSV headera.
                const lokacija = row['LOKACIJA'];
                // Preskačemo redove koji nemaju lokaciju (često prazni redovi ili footer u CSV-u)
                if (!lokacija || !row['TEMPERATURA ZRAKA C°']) return;

                const datum = row['DATUM'] || "";
                const vrijeme = row['VRIJEME'] || "";

                const temp = row['TEMPERATURA ZRAKA C°'] || "-";
                const tempMin = row['MIN TEMP. C°'] || "-";
                const tempMax = row['MAX TEMP. C°'] || "-";

                const vjetarSmjer = row['SMJER VJETRA'] || "";
                const vjetarBrzina = row['VJETAR [m/s]'] || "-";
                const vjetarUdari = row['MAX UDARI VJETRA [m/s]'] || "-";

                const tlak = row['TLAK ZRAKA [hPa]'] || "-";
                const vlaga = row['VLAGA [%]'] || "-";

                const oborinaSat = row['SATNA OBORINA [mm]'] || "-";
                const oborinaDan = row['DNEVNA OBORINA [mm]'] || "-";
                const oborinaMjesec = row['MJESEČNA OBORINA [mm]'] || "-";


                const tr = document.createElement('div');
                tr.className = 'grid-row';

                tr.innerHTML = `
        <div class="meteo-location cell-loc" data-label="Lokacija">
          ${lokacija}
        </div>
        <div class="text-center cell-time" data-label="Datum/Vrijeme">
          ${datum}<br>${vrijeme}
        </div>
        
        <!-- Temp -->
        <div class="text-center meteo-temp-current cell-temp-curr" data-label="Temp (Trenutna)">${temp}</div>
        <div class="text-center meteo-temp-min cell-temp-min" data-label="Temp (Min)">${tempMin}</div>
        <div class="text-center meteo-temp-max cell-temp-max" data-label="Temp (Max)">${tempMax}</div>

        <!-- Wind -->
        <div class="text-center meteo-wind-direction cell-wind-dir" data-label="Vjetar (Smjer)">${vjetarSmjer}</div>
        <div class="text-center meteo-wind-speed cell-wind-val" data-label="Vjetar (Brzina)">${vjetarBrzina}</div>
        <div class="text-center meteo-wind-gust cell-wind-gust" data-label="Vjetar (Udari)">${vjetarUdari}</div>

        <!-- Pressure/Humidity -->
        <div class="text-center meteo-pressure cell-pres" data-label="Tlak">${tlak}</div>
        <div class="text-center meteo-humidity cell-hum" data-label="Vlaga">${vlaga}</div>

        <!-- Rain -->
        <div class="text-center meteo-rain cell-rain-h" data-label="Oborina (Satna)">${oborinaSat}</div>
        <div class="text-center meteo-rain-daily cell-rain-d" data-label="Oborina (Dnevna)">${oborinaDan}</div>
        <div class="text-center meteo-rain cell-rain-m" data-label="Oborina (Mjesečna)">${oborinaMjesec}</div>
      `;
                tbody.appendChild(tr);
            });
        }

        init(); // 1 min refresh
    </script>
</body>

</html>